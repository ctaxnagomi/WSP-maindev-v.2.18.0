-- Create the guest_pins table in Supabase
-- Run this in your Supabase SQL editor (Dashboard > SQL Editor > New Query)

-- Enable UUID extension if not already (usually is)
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create the table
CREATE TABLE IF NOT EXISTS guest_pins (
  id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,
  pin text UNIQUE NOT NULL,
  active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Insert the valid PINs (all active)
INSERT INTO guest_pins (pin) VALUES
('48291'), ('30517'), ('97203'), ('18450'), ('62038'), ('75912'), ('04186'), ('59320'), ('81746'), ('23059'),
('49618'), ('30592'), ('17403'), ('82049'), ('56321'), ('90734'), ('12895'), ('47036'), ('65128'), ('39407'),
('08253'), ('71904'), ('36520'), ('48197'), ('20536'), ('93017'), ('67428'), ('15093'), ('28764'), ('83901'),
('41756'), ('20834'), ('69512'), ('73140'), ('59408'), ('32679'), ('84015'), ('26730'), ('59182'), ('40397'),
('15827'), ('97036'), ('46219'), ('83104'), ('59720'), ('34861'), ('70429'), ('21603'), ('58947'), ('43068'),
('19205'), ('36748'), ('82019'), ('47503'), ('93612'), ('15087'), ('20493'), ('67128'), ('58309'), ('74921'),
('43057'), ('18296'), ('95023'), ('61704'), ('28391'), ('50468'), ('71935'), ('26841'), ('39507'), ('80412'),
('52039'), ('68317'), ('09426'), ('73150'), ('58209'), ('46931'), ('21708'), ('39562'), ('84057'), ('10394'),
('67201'), ('45836'), ('29307'), ('51748'), ('90612'), ('37489'), ('82015'), ('49136'), ('25370'), ('61804'),
('39512'), ('20768'), ('84159'), ('30274'), ('57901'), ('64028'), ('19357'), ('80724'), ('56230'), ('48196'),
('37052'), ('61948'), ('20573'), ('98416'), ('37109'), ('82046'), ('15738'), ('69420'), ('50391'), ('72840'),
('29157'), ('46803'), ('10529'), ('73648'), ('59012'), ('24736'), ('81305'), ('42961'), ('50738'), ('19624'),
('85047'), ('26319'), ('47180'), ('39526'), ('72841'), ('60493'), ('18250'), ('57964'), ('31028'), ('94705'),
('62391'), ('15840'), ('79423'), ('50618'), ('37109'), ('82064'), ('14537'), ('96802'), ('43091'), ('75268'),
('39105'), ('64728'), ('20539'), ('81374'), ('50621'), ('94703'), ('18264'), ('35907'), ('62841'), ('50329'),
('47186'), ('20935'), ('61748'), ('39405'), ('80217'), ('56320'), ('14892'), ('97036'), ('21508'), ('63497'),
('58012'), ('42973'), ('17604'), ('80539'), ('61728'), ('34059'), ('29176'), ('58304'), ('97215'), ('40638'),
('15209'), ('67438'), ('59012'), ('32849'), ('70516'), ('49328'), ('21705'), ('83902'), ('46175'), ('20839'),
('59712'), ('34086'), ('71205'), ('43069'), ('28517'), ('94603'), ('57128'), ('30946'), ('18250'), ('69431'),
('50827'), ('73610'), ('49185'), ('23097'), ('61740'), ('38529'), ('07416'), ('82953'), ('46018'), ('27509'),
('39164'), ('82057'), ('13628'), ('49502'), ('76103'), ('28419'), ('50736'), ('92048'), ('61375'), ('24809'),
('57102'), ('39486'), ('80521'), ('63749'), ('12058'), ('94731'), ('28506'), ('46172'), ('59308'), ('70416'),
('23895'), ('61704'), ('39528'), ('80216'), ('47309'), ('15928'), ('64037'), ('21580'), ('98341'), ('57206'),
('39418'), ('62057'), ('10839'), ('75426'), ('39105'), ('68720'), ('50391'), ('24786'), ('91035'), ('68241'),
('37509'), ('20418'), ('63957'), ('81024'), ('57203'), ('49618'), ('30759'), ('18246'), ('95037'), ('26418')
ON CONFLICT (pin) DO NOTHING;  -- Avoid duplicates if re-run

-- Create RPC function for PIN validation (run this after table creation)
CREATE OR REPLACE FUNCTION validate_pin(pin_input text)
RETURNS TABLE (valid boolean)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  RETURN QUERY
  SELECT EXISTS (
    SELECT 1 FROM guest_pins 
    WHERE pin = pin_input AND active = true
  ) AS valid;
END;
$$;

-- Grant permissions (for anon role)
GRANT USAGE ON SCHEMA public TO anon, authenticated;
GRANT SELECT ON guest_pins TO anon, authenticated;
GRANT EXECUTE ON FUNCTION validate_pin(text) TO anon, authenticated;